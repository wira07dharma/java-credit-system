<%-- 
    Document   : riwayat_pembayaran_kredit
    Created on : Apr 30, 2019, 8:59:26 AM
    Author     : Dimata 007
--%>

<%@page import="com.dimata.sedana.entity.masterdata.PstJangkaWaktu"%>
<%@page import="com.dimata.sedana.entity.masterdata.JangkaWaktu"%>
<%@page import="com.dimata.pos.entity.billing.PstBillDetail"%>
<%@page import="com.dimata.pos.entity.billing.Billdetail"%>
<%@page import="com.dimata.pos.entity.billing.PstBillMain"%>
<%@page import="com.dimata.pos.entity.billing.BillMain"%>
<%@page import="com.dimata.aiso.entity.masterdata.mastertabungan.JenisKredit"%>
<%@page import="com.dimata.sedana.entity.kredit.Angsuran"%>
<%@page import="com.dimata.sedana.entity.tabungan.Transaksi"%>
<%@page import="com.dimata.aiso.entity.masterdata.anggota.Anggota"%>
<%@page import="com.dimata.sedana.entity.kredit.Pinjaman"%>
<%@page import="com.dimata.sedana.session.SessReportKredit"%>
<%@page import="com.dimata.util.*"%>
<%@page contentType="text/html" pageEncoding="UTF-8"%>
<%@ include file = "../../main/javainit.jsp" %>
<% int  appObjCode =  AppObjInfo.composeObjCode(AppObjInfo.G1_SEDANA, AppObjInfo.G2_REPORT, AppObjInfo.OBJ_RIWAYAT_PEMBAYARAN_KREDIT); %>
<%@ include file = "../../main/checkuser.jsp" %>
<%
/* Check privilege except VIEW, view is already checked on checkuser.jsp as basic access*/
boolean privView=userSession.checkPrivilege(AppObjInfo.composeCode(appObjCode, AppObjInfo.COMMAND_VIEW));
boolean privAdd=userSession.checkPrivilege(AppObjInfo.composeCode(appObjCode, AppObjInfo.COMMAND_ADD));
boolean privUpdate=userSession.checkPrivilege(AppObjInfo.composeCode(appObjCode, AppObjInfo.COMMAND_UPDATE));
boolean privDelete=userSession.checkPrivilege(AppObjInfo.composeCode(appObjCode, AppObjInfo.COMMAND_DELETE));

//if of "hasn't access" condition 
if(!privView && !privAdd && !privUpdate && !privDelete){
	response.sendRedirect(approot + "/nopriv.html"); 
}
%>
<%//
    int iCommand = FRMQueryString.requestCommand(request);
    String nomorKredit = FRMQueryString.requestString(request, "no_kredit");
    String useForRaditya = PstSystemProperty.getValueByName("USE_FOR_RADITYA"); 
    
    ArrayList<ArrayList> listPembayaran = new ArrayList();
    if (iCommand == Command.LIST) {
        listPembayaran = SessReportKredit.listRiwayatAngsuranKredit(nomorKredit);
    }
%>

<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <%@ include file = "/style/style_kredit.jsp" %>
        <style>
            table {font-size: 14px}
            .tabel_header td {
                padding-right: 10px;
                padding-bottom: 3px;
                vertical-align: text-top;
            }
        </style>
        <script>
            $(document).ready(function () {
                $('#btnPrint').click(function () {
                    var buttonHtml = $(this).html();
                    $(this).attr({"disabled": "true"}).html("Tunggu...");
                    window.print();
                    $(this).removeAttr('disabled').html(buttonHtml);
                });
                
                $('#form_cari').submit(function () {
                    $('.btn-search').attr({"disabled": "true"}).html("Tunggu...");
                });
            });
        </script>
    </head>
    <body style="background-color: #eaf3df;">
        <div class="main-page">
            <section class="content-header">
                <h1>
                    Laporan Mutasi Angsuran Kredit
                    <small></small>
                </h1>
                <ol class="breadcrumb">
                    <li><a href="<%=approot%>/homexframe.jsp"><i class="fa fa-dashboard"></i> Home</a></li>
                    <li>Laporan</li>
                    <li class="active">Kredit</li>
                </ol>
            </section>

            <section class="content">
                <div class="box box-success">
                    <div class="box-header with-border" style="border-color: lightgray">
                        <h3 class="box-title">Form Pencarian</h3>
                    </div>
                    <div class="box-body">
                        <form id="form_cari" class="form-inline" method="post" action="?command=<%=Command.LIST%>">
                            <input type="text" required="" class="form-control input-sm" placeholder="Nomor kredit" name="no_kredit" value="<%= nomorKredit%>">
                            <button type="submit" class="btn btn-sm btn-primary btn-search"><i class="fa fa-search"></i>&nbsp; Cari</button>
                        </form>
                    </div>
                </div>

                <% if (iCommand == Command.LIST) {%>

                <%
                    String noKredit = "";
                    String nama = "";
                    double jumlahPinjaman = 0;
                    String alamat = "";
                    String jatuhTempo = "";
                    String tglLunas = "";
                    double sukuBunga = 0;
                    int jangkaWaktu = 0;
                    String tipeFrekuensi = "";
                    String namaBarang = "";
                    BillMain bm = new BillMain();
                    Billdetail bd = new Billdetail();
                    JangkaWaktu jk = new JangkaWaktu();

                    for (ArrayList al : listPembayaran) {
                        Pinjaman p = (Pinjaman) al.get(0);
                        Anggota a = (Anggota) al.get(1);
                        JenisKredit k = (JenisKredit) al.get(4);
                        try {
                            bm = PstBillMain.fetchExc(p.getBillMainId());
                            jk = PstJangkaWaktu.fetchExc(p.getJangkaWaktuId());
                          } catch (Exception e) {
                          }
                        noKredit = p.getNoKredit();
                        nama = a.getName();
                        jumlahPinjaman = p.getJumlahPinjaman();
                        alamat = a.getAddressPermanent();
                        jatuhTempo = Formater.formatDate(p.getJatuhTempo(), "dd MMMM yyyy");
                        tglLunas = Formater.formatDate(p.getTglLunas(), "dd MMMM yyyy");
                        sukuBunga = p.getSukuBunga();
                        jangkaWaktu = jk.getJangkaWaktu();
                        namaBarang = bm.getItemName();
                        String arrayTipeFrekuensi[] = Transaksi.TIPE_KREDIT.get(k.getTipeFrekuensiPokokLegacy());
                        tipeFrekuensi = arrayTipeFrekuensi[SESS_LANGUAGE];
                        break;
                    }
                %>

                <div class="box box-success">
                    <div class="box-header with-border" style="border-color: lightgray">
                        <h3 class="box-title">Laporan Mutasi Angsuran Kredit</h3>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="col-sm-6">
                                <table class="tabel_header">
                                    <tr>
                                        <td>Nomor Kredit</td>
                                        <td>:</td>
                                        <td><%= noKredit%></td>
                                    </tr>
                                    <tr>
                                        <td>Nama</td>
                                        <td>:</td>
                                        <td><%= nama%></td>
                                    </tr>
                                    <tr>
                                        <td>Alamat</td>
                                        <td>:</td>
                                        <td><%= alamat%></td>
                                    </tr>
                                    <tr>
                                        <td>Jumlah Pinjaman</td>
                                        <td>:</td>
                                        <td><span class="money"><%= jumlahPinjaman%></span></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-sm-6">
                                <table class="tabel_header">
                                  <%if(useForRaditya.equals("1")){%>
                                    <tr>
                                        <td>Nama Barang</td>
                                        <td>:</td>
                                        <%
                                        Vector listItem = PstBillDetail.list(0, 0, PstBillDetail.fieldNames[PstBillDetail.FLD_BILL_MAIN_ID]+ "=" +bm.getOID() , "");
                                        for(int i = 0; i < listItem.size(); i++){
                                        bd = (Billdetail) listItem.get(i);
                                        %>
                                        <% if(listItem.size() > 1){%>
                                        <td><%= bd.getItemName() %>,</td>
                                        <%}else{%>
                                        <td><%= bd.getItemName() %></td>
                                        <%}}%>
                                    </tr>
                                  <%}else{%>
                                    <tr>
                                        <td>Suku Bunga</td>
                                        <td>:</td>
                                        <td><%= sukuBunga%> % / Tahun</td>
                                    </tr>
                                  <%}%>
                                    <tr>
                                        <td>Jangka Waktu</td>
                                        <td>:</td>
                                        <td><%= jangkaWaktu%> <%= tipeFrekuensi%></td>
                                    </tr>
                                    <tr>
                                        <td>Jatuh Tempo</td>
                                        <td>:</td>
                                        <td><%= jatuhTempo%></td>
                                    </tr>
                                    <tr>
                                        <td>Tanggal Lunas</td>
                                        <td>:</td>
                                        <td><%= tglLunas%></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <p></p>
                        <div class="table-responsive">
                          <%if(useForRaditya.equals("1")){%>
                            <table class="table table-bordered table-hover">
                                <tr>
                                    <th>No.</th>
                                    <th>Nomor Transaksi</th>
                                    <th>Tanggal Bayar</th>
                                    <th>Angsuran Dibayar</th>
                                    <th>Total Bayar</th>
                                    <th>Sisa Angsuran</th>
                                    <th>Keterangan</th>
                                </tr>

                                <% if (listPembayaran.isEmpty()) { %>
                                <tr>
                                    <td colspan="8" class="text-center label-default">Tidak ada data pembayaran</td>
                                </tr>
                                <% } %>

                                <%
                                    double totalPokokDibayar = 0;
                                    int no = 0;
                                    for (ArrayList al : listPembayaran) {
                                        Pinjaman p = (Pinjaman) al.get(0);
                                        Transaksi t = (Transaksi) al.get(2);
                                        Angsuran angsuran = (Angsuran) al.get(3);

                                        no++;
                                        String tglBayar = Formater.formatDate(t.getTanggalTransaksi(), "yyyy-MM-dd HH:mm:ss");
                                        double pokokDibayar = p.getJumlahAngsuran();
                                        double bungaDibayar = angsuran.getJumlahAngsuran();
                                        double totalBayar = pokokDibayar + bungaDibayar;
                                        totalPokokDibayar += pokokDibayar;
                                        double sisaPokok = p.getJumlahPinjaman() - totalPokokDibayar;
                                %>

                                <tr>
                                    <td style="width: 1%"><%= no%>.</td>
                                    <td><%= t.getKodeBuktiTransaksi()%></td>
                                    <td><%= tglBayar%></td>
                                    <td class="money text-right"><%= pokokDibayar%></td>
                                    <td class="money text-right"><%= totalBayar%></td>
                                    <td class="money text-right"><%= sisaPokok%></td>
                                    <td><%= t.getKeterangan()%></td>
                                </tr>

                                <%
                                    }
                                %>

                            </table>
                          <%}else{%>
                          <table class="table table-bordered table-hover">
                                <tr>
                                    <th>No.</th>
                                    <th>Nomor Transaksi</th>
                                    <th>Tanggal Bayar</th>
                                    <th>Pokok Dibayar</th>
                                    <th>Bunga Dibayar</th>
                                    <th>Total Bayar</th>
                                    <th>Sisa Pokok</th>
                                    <th>Keterangan</th>
                                </tr>

                                <% if (listPembayaran.isEmpty()) { %>
                                <tr>
                                    <td colspan="8" class="text-center label-default">Tidak ada data pembayaran</td>
                                </tr>
                                <% } %>

                                <%
                                    double totalPokokDibayar = 0;
                                    int no = 0;
                                    for (ArrayList al : listPembayaran) {
                                        Pinjaman p = (Pinjaman) al.get(0);
                                        Transaksi t = (Transaksi) al.get(2);
                                        Angsuran angsuran = (Angsuran) al.get(3);

                                        no++;
                                        String tglBayar = Formater.formatDate(t.getTanggalTransaksi(), "yyyy-MM-dd HH:mm:ss");
                                        double pokokDibayar = p.getJumlahAngsuran();
                                        double bungaDibayar = angsuran.getJumlahAngsuran();
                                        double totalBayar = pokokDibayar + bungaDibayar;
                                        totalPokokDibayar += pokokDibayar;
                                        double sisaPokok = p.getJumlahPinjaman() - totalPokokDibayar;
                                %>

                                <tr>
                                    <td style="width: 1%"><%= no%>.</td>
                                    <td><%= t.getKodeBuktiTransaksi()%></td>
                                    <td><%= tglBayar%></td>
                                    <td class="money text-right"><%= pokokDibayar%></td>
                                    <td class="money text-right"><%= bungaDibayar%></td>
                                    <td class="money text-right"><%= totalBayar%></td>
                                    <td class="money text-right"><%= sisaPokok%></td>
                                    <td><%= t.getKeterangan()%></td>
                                </tr>

                                <%
                                    }
                                %>

                            </table>
                          <%}%>

                        </div>
                                
                        <% if (!listPembayaran.isEmpty()) { %>
                        <button type="button" id="btnPrint" class="btn btn-sm btn-primary"><i class="fa fa-file-text"></i>&nbsp; Cetak</button>
                        <% } %>
                    </div>
                </div>

                <% }%>
            </section>
        </div>
    </body>
    <% if (iCommand == Command.LIST) {%>
    
    <%
        String noKredit = "";
        String nama = "";
        double jumlahPinjaman = 0;
        String alamat = "";
        String jatuhTempo = "";
        String tglLunas = "";
        double sukuBunga = 0;
        int jangkaWaktu = 0;
        String tipeFrekuensi = "";
        String namaBarang = "";
        Billdetail bd = new Billdetail();
        BillMain bm = new BillMain();
        JangkaWaktu jk = new JangkaWaktu();
        
        for (ArrayList al : listPembayaran) {
            Pinjaman p = (Pinjaman) al.get(0);
            Anggota a = (Anggota) al.get(1);
            Transaksi t = (Transaksi) al.get(2);
            JenisKredit k = (JenisKredit) al.get(4);
            try {
                bm = PstBillMain.fetchExc(p.getBillMainId());
                jk = PstJangkaWaktu.fetchExc(p.getJangkaWaktuId());
              } catch (Exception e) {
              }

            noKredit = p.getNoKredit();
            nama = a.getName();
            jumlahPinjaman = p.getJumlahPinjaman();
            alamat = a.getAddressPermanent();
            jatuhTempo = Formater.formatDate(p.getJatuhTempo(), "dd MMMM yyyy");
            tglLunas = Formater.formatDate(p.getTglLunas(), "dd MMMM yyyy");
            sukuBunga = p.getSukuBunga();
            jangkaWaktu = jk.getJangkaWaktu();
            namaBarang = bm.getItemName();
            String arrayTipeFrekuensi[] = Transaksi.TIPE_KREDIT.get(k.getTipeFrekuensiPokokLegacy());
            tipeFrekuensi = arrayTipeFrekuensi[SESS_LANGUAGE];
            break;
        }
    %>
    
    <print-area style="size: A5">
        <div style="width: 50%; float: left;">
            <strong style="width: 100%; display: inline-block; font-size: 20px;"><%=compName%></strong>
            <span style="width: 100%; display: inline-block;"><%=compAddr%></span>
            <span style="width: 100%; display: inline-block;"><%=compPhone%></span>                    
        </div>
        <div style="width: 50%; float: right; text-align: right">
            <span style="width: 100%; display: inline-block; font-weight: 400; font-size: 20px;">LAPORAN MUTASI ANGSURAN KREDIT</span>
            <span style="width: 100%; display: inline-block; font-size: 12px;">Tanggal : <%=Formater.formatDate(new Date(), "dd MMM yyyy / HH:mm:ss")%></span>                    
            <span style="width: 100%; display: inline-block; font-size: 12px;">Admin : <%=userName%></span>                    
        </div>
        <div class="clearfix"></div>
        <hr class="" style="border-color: gray">  
        <div style="width: 50%; float: left;">
            <table class="tabel_header" style="font-size: 10px">
                <tr>
                    <td>Nomor Kredit</td>
                    <td>:</td>
                    <td><%= noKredit%></td>
                </tr>
                <tr>
                    <td>Nama</td>
                    <td>:</td>
                    <td><%= nama%></td>
                </tr>
                <tr>
                    <td>Alamat</td>
                    <td>:</td>
                    <td><%= alamat%></td>
                </tr>
                <tr>
                    <td>Jumlah Pinjaman</td>
                    <td>:</td>
                    <td>Rp <span class="money"><%= jumlahPinjaman%></span></td>
                </tr>
            </table>
        </div>
        <div style="width: 50%; float: right; text-align: right">
            <table class="tabel_header" style="font-size: 10px">
                <%if(useForRaditya.equals("1")){%>
                <tr>
                        <td>Nama Barang</td>
                        <td>:</td>
                        <%
                        Vector listItem = PstBillDetail.list(0, 0, PstBillDetail.fieldNames[PstBillDetail.FLD_BILL_MAIN_ID]+ "=" +bm.getOID() , "");
                        for(int i = 0; i < listItem.size(); i++){
                        bd = (Billdetail) listItem.get(i);
                        %>
                        <% if(listItem.size() > 1){%>
                        <td><%= bd.getItemName() %>,</td>
                        <%}else{%>
                        <td><%= bd.getItemName() %></td>
                        <%}}%>
                    </tr>
                <%}else{%>
                  <tr>
                    <td>Suku Bunga</td>
                    <td>:</td>
                    <td><%= sukuBunga%> % / Tahun</td>
                </tr>
                <%}%>
                <tr>
                    <td>Jangka Waktu</td>
                    <td>:</td>
                    <td><%= jangkaWaktu%> <%= tipeFrekuensi%></td>
                </tr>
                <tr>
                    <td>Jatuh Tempo</td>
                    <td>:</td>
                    <td><%= jatuhTempo%></td>
                </tr>
                <tr>
                    <td>Tanggal Lunas</td>
                    <td>:</td>
                    <td><%= tglLunas%></td>
                </tr>
            </table>
        </div>
        <div class="clearfix"></div>
        <br>
        <style>
            .tabel_print {width: 100%}
            
            .tabel_print th {
                padding: 5px !important;
                border-style: solid;
                border-width: thin;
                border-color: lightgray;
                border-right: none;
                border-left: none;
                white-space: nowrap;
            }
            
            .tabel_print td {
                padding: 5px;
                border-style: solid;
                border-width: thin;
                border-color: lightgray;
                border-right: none;
                border-left: none;
                vertical-align: text-top
            }
            
        </style>
        <label style="font-size: 10px">Transaksi pembayaran :</label>
        <%if(useForRaditya.equals("1")){%>
        <table class="tabel_print" style="font-size: 10px">
            <tr>
                <th class="text-left">No.</th>
                <th class="text-left">Nomor Transaksi</th>
                <th class="text-left">Tanggal Bayar</th>
                <th class="text-right">Angsuran Dibayar</th>
                <th class="text-right">Total Bayar</th>
                <th class="text-right">Sisa Angsuran</th>
                <th class="text-left">Keterangan</th>
            </tr>

            <% if (listPembayaran.isEmpty()) { %>
            <tr>
                <td colspan="8" class="text-center label-default">Tidak ada data pembayaran</td>
            </tr>
            <% } %>

            <%
                double totalPokokDibayar = 0;
                int no = 0;
                for (ArrayList al : listPembayaran) {
                    Pinjaman p = (Pinjaman) al.get(0);
                    Transaksi t = (Transaksi) al.get(2);
                    Angsuran angsuran = (Angsuran) al.get(3);

                    no++;
                    String tglBayar = Formater.formatDate(t.getTanggalTransaksi(), "yyyy-MM-dd HH:mm:ss");
                    double pokokDibayar = p.getJumlahAngsuran();
                    double bungaDibayar = angsuran.getJumlahAngsuran();
                    double totalBayar = pokokDibayar + bungaDibayar;
                    totalPokokDibayar += pokokDibayar;
                    double sisaPokok = p.getJumlahPinjaman() - totalPokokDibayar;
            %>

            <tr>
                <td style="width: 1%"><%= no%>.</td>
                <td style="white-space: nowrap"><%= t.getKodeBuktiTransaksi()%></td>
                <td style="white-space: nowrap"><%= tglBayar%></td>
                <td class="money text-right"><%= pokokDibayar%></td>
                <td class="money text-right"><%= totalBayar%></td>
                <td class="money text-right"><%= sisaPokok%></td>
                <td><%= t.getKeterangan()%></td>
            </tr>

            <%
                }
            %>

        </table>
        <%}else{%>
        <table class="tabel_print" style="font-size: 10px">
            <tr>
                <th class="text-left">No.</th>
                <th class="text-left">Nomor Transaksi</th>
                <th class="text-left">Tanggal Bayar</th>
                <th class="text-right">Pokok Dibayar</th>
                <th class="text-right">Bunga Dibayar</th>
                <th class="text-right">Total Bayar</th>
                <th class="text-right">Sisa Pokok</th>
                <th class="text-left">Keterangan</th>
            </tr>

            <% if (listPembayaran.isEmpty()) { %>
            <tr>
                <td colspan="8" class="text-center label-default">Tidak ada data pembayaran</td>
            </tr>
            <% } %>

            <%
                double totalPokokDibayar = 0;
                int no = 0;
                for (ArrayList al : listPembayaran) {
                    Pinjaman p = (Pinjaman) al.get(0);
                    Transaksi t = (Transaksi) al.get(2);
                    Angsuran angsuran = (Angsuran) al.get(3);

                    no++;
                    String tglBayar = Formater.formatDate(t.getTanggalTransaksi(), "yyyy-MM-dd HH:mm:ss");
                    double pokokDibayar = p.getJumlahAngsuran();
                    double bungaDibayar = angsuran.getJumlahAngsuran();
                    double totalBayar = pokokDibayar + bungaDibayar;
                    totalPokokDibayar += pokokDibayar;
                    double sisaPokok = p.getJumlahPinjaman() - totalPokokDibayar;
            %>

            <tr>
                <td style="width: 1%"><%= no%>.</td>
                <td style="white-space: nowrap"><%= t.getKodeBuktiTransaksi()%></td>
                <td style="white-space: nowrap"><%= tglBayar%></td>
                <td class="money text-right"><%= pokokDibayar%></td>
                <td class="money text-right"><%= bungaDibayar%></td>
                <td class="money text-right"><%= totalBayar%></td>
                <td class="money text-right"><%= sisaPokok%></td>
                <td><%= t.getKeterangan()%></td>
            </tr>

            <%
                }
            %>

        </table>
        <%}%>

    </print-area>
        
    <% } %>
</html>
