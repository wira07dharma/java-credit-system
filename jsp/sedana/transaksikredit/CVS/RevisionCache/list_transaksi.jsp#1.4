<%-- 
    Document   : list_transaksi
    Created on : Oct 13, 2017, 3:57:34 PM
    Author     : Dimata 007
--%>
<%@page import="com.dimata.sedana.session.SessHistory"%>
<%@page import="com.dimata.sedana.session.json.JSONArray"%>
<%@page import="com.dimata.sedana.entity.kredit.PstJadwalAngsuran"%>
<%@page import="com.dimata.sedana.entity.kredit.JadwalAngsuran"%>
<%@page import="com.dimata.common.entity.contact.PstContactClass"%>
<%@page import="com.dimata.aiso.session.masterdata.SessAnggota"%>
<%@page import="com.dimata.sedana.entity.kredit.Angsuran"%>
<%@page import="com.dimata.sedana.entity.kredit.PstAngsuran"%>
<%@page import="com.dimata.sedana.entity.tabungan.PstTransaksi"%>
<%@page import="com.dimata.aiso.entity.masterdata.anggota.PstAnggota"%>
<%@page import="com.dimata.aiso.entity.masterdata.anggota.Anggota"%>
<%@page import="com.dimata.sedana.entity.tabungan.Transaksi"%>
<%@page import="com.dimata.sedana.entity.kredit.PstPinjaman"%>
<%@page import="com.dimata.sedana.entity.kredit.Pinjaman"%>
<%@page import="com.dimata.sedana.session.SessKredit"%>
<%@page import="com.dimata.util.Formater"%>
<%@page import="com.dimata.util.Command"%>
<%@page contentType="text/html" pageEncoding="UTF-8"%>
<%@ include file = "../../main/javainit.jsp" %>
<%@ include file = "../../main/checkuser.jsp" %>

<%!
    public static final String dataTableTitle[][] = {
        {"Tampilkan _MENU_ data per halaman", 
        "Data Tidak Ditemukan", 
        "Menampilkan halaman _PAGE_ dari _PAGES_",
        "Belum Ada Data",
        "(Disaring dari _MAX_ data)",
        "Pencarian :",
        "Awal",
        "Akhir",
        "Berikutnya",
        "Sebelumnya"}, 
        
        {"Display _MENU_ records per page", 
        "Nothing found - sorry",
        "Showing page _PAGE_ of _PAGES_",
        "No records available",
        "(filtered from _MAX_ total records)",
        "Search :",
        "First",
        "Last",
        "Next",
        "Previous"}
    };
%>

<%//
    int print = FRMQueryString.requestInt(request, "print_list_transaksi");
    int showHistory = FRMQueryString.requestInt(request, "show_history");
    String tglAwal = FRMQueryString.requestString(request, "FRM_TGL_AWAL");
    String tglAkhir = FRMQueryString.requestString(request, "FRM_TGL_AKHIR");
    String arrayNasabah[] = request.getParameterValues("FRM_NASABAH");
    String arrayTransaksi[] = request.getParameterValues("FRM_TRANSAKSI");
    String addSql = "";
    if (!tglAwal.equals("") && !tglAkhir.equals("")) {
        addSql += " AND DATE(t." + PstTransaksi.fieldNames[PstTransaksi.FLD_TANGGAL_TRANSAKSI] + ") >= '" + tglAwal + "'"
                + " AND DATE(t." + PstTransaksi.fieldNames[PstTransaksi.FLD_TANGGAL_TRANSAKSI] + ") <= '" + tglAkhir + "'";
    }
    String nasabah = "";
    if (arrayNasabah != null) {
        String idNasabah = "";
        for (int i = 0; i < arrayNasabah.length; i++) {
            if (i > 0) {
                idNasabah += ",";
                nasabah += ", ";
            }
            idNasabah += "" + arrayNasabah[i];
            Anggota a = PstAnggota.fetchExc(Long.valueOf(arrayNasabah[i]));
            nasabah += "" + a.getName();
        }
        if (!idNasabah.equals("")) {
            addSql += " AND a." + PstAnggota.fieldNames[PstAnggota.FLD_ID_ANGGOTA] + " IN (" + idNasabah + ")";
        }
    } else {
        nasabah = "Semua " + namaNasabah;
    }
    
    String namaTransaksi = "";
    if (arrayTransaksi != null) {
        String kodeTransaksi = "";
        for (int i = 0; i < arrayTransaksi.length; i++) {
            if (i > 0) {
                kodeTransaksi += ",";
                namaTransaksi += ", ";
            }
            kodeTransaksi += "" + arrayTransaksi[i];
            namaTransaksi += "" + Transaksi.USECASE_TYPE_TITLE.get(Integer.valueOf(arrayTransaksi[i]));
        }
        if (!kodeTransaksi.equals("")) {
            addSql += " AND t." + PstTransaksi.fieldNames[PstTransaksi.FLD_USECASE_TYPE] + " IN (" + kodeTransaksi + ")";
        }
    } else {
        namaTransaksi = "Semua transaksi";
    }
    
    Vector listTransaksi = SessKredit.getListTransaksiKredit(0, 0, ""
            + " (t." + PstTransaksi.fieldNames[PstTransaksi.FLD_USECASE_TYPE] + " IN ("
              + Transaksi.USECASE_TYPE_KREDIT_PENCAIRAN
              + "," + Transaksi.USECASE_TYPE_KREDIT_ANGSURAN_PAYMENT
              + "," + Transaksi.USECASE_TYPE_KREDIT_BUNGA_TAMBAHAN_PENCATATAN
              + "," + Transaksi.USECASE_TYPE_KREDIT_DENDA_PENCATATAN
              + ")"
              + ")"
            + addSql
            + " GROUP BY " + PstTransaksi.fieldNames[PstTransaksi.FLD_TRANSAKSI_ID], PstTransaksi.fieldNames[PstTransaksi.FLD_TANGGAL_TRANSAKSI] + " DESC ");

    String textTglAwal = "";
    String textTglAkhir = "";
    Date now = new Date();    
    textTglAwal = Formater.formatDate(now, "dd MMM yyyy");    
    textTglAkhir = Formater.formatDate(now, "dd MMM yyyy");
    if (!tglAwal.equals("") && !tglAkhir.equals("")) {
        Date dAwal = Formater.formatDate(tglAwal, "yyyy-MM-dd");    
        textTglAwal = Formater.formatDate(dAwal, "dd MMM yyyy");   
        Date dAkhir = Formater.formatDate(tglAkhir, "yyyy-MM-dd");
        textTglAkhir = Formater.formatDate(dAkhir, "dd MMM yyyy");
    }

%>
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
        <%@ include file = "/style/style_kredit.jsp" %>
        
        <style>
            th {text-align: center; font-weight: normal; vertical-align: middle !important}
            th {background-color: #00a65a; color: white; padding-right: 8px !important}
            .modal-header, .modal-footer {padding-bottom: 10px; padding-top: 10px !important}
            th:after {display: none !important;}
            .aksi {width: 1% !important}
            .btn_detail:hover {cursor: pointer}
            
            .tabel_data_print {font-size: 10px}

            print-area { visibility: hidden; display: none; }
            print-area.preview { visibility: visible; display: block; }
            @media print
            {
                body .main-page * { visibility: hidden; display: none; } 
                body print-area * { visibility: visible; }
                body print-area   { visibility: visible; display: unset !important; position: static; top: 0; left: 0; }
            }
        </style>
        
        <script src="<%=approot%>/MaskMoney.js?sub=<%=userOID%>&cf=<%=Formater.formatDate(new Date(), "yyyyMMddHHmm")%>" type="text/javascript"></script>
        
        <script language="javascript">
            $(document).ready(function () {

                var getDataFunction = function (onDone, onSuccess, dataSend, servletName, dataAppendTo, notification) {
                    $(this).getData({
                        onDone: function (data) {
                            onDone(data);
                        },
                        onSuccess: function (data) {
                            onSuccess(data);
                        },
                        approot: "<%=approot%>",
                        dataSend: dataSend,
                        servletName: servletName,
                        dataAppendTo: dataAppendTo,
                        notification: notification
                    });
                };

                // DATABLE SETTING
                function dataTablesOptions(elementIdParent, elementId, servletName, dataFor, callBackDataTables) {
                    //parameter tambahan
                    var tglAwal = $('#tgl_awal').val();
                    var tglAkhir = $('#tgl_akhir').val();
                    var nasabah = $('#id_nasabah').val();
                    var transaksi = $('#kode_transaksi').val();

                    var datafilter = "";
                    var privUpdate = "";
                    $(elementIdParent).find('table').addClass('table-bordered table-striped table-hover').attr({'id': elementId});
                    $("#" + elementId).dataTable({"bDestroy": true,
                        "searching": true,
                        "iDisplayLength": 10,
                        "bProcessing": true,
                        "oLanguage": {
                            "sProcessing": "<div class='col-sm-12'><div class='progress progress-striped active'><div class='progress-bar progress-bar-primary' style='width: 100%'><b>Please Wait...</b></div></div></div>",
                            "sLengthMenu": "<%=dataTableTitle[SESS_LANGUAGE][0]%>",
                            "sZeroRecords": "<%=dataTableTitle[SESS_LANGUAGE][1]%>",
                            "sInfo": "<%=dataTableTitle[SESS_LANGUAGE][2]%>",
                            "sInfoEmpty": "<%=dataTableTitle[SESS_LANGUAGE][3]%>",
                            "sInfoFiltered": "<%=dataTableTitle[SESS_LANGUAGE][4]%>",
                            "sSearch": "<%=dataTableTitle[SESS_LANGUAGE][5]%>",
                            "oPaginate": {
                                "sFirst ": "<%=dataTableTitle[SESS_LANGUAGE][6]%>",
                                "sLast ":  "<%=dataTableTitle[SESS_LANGUAGE][7]%>",
                                "sNext ":  "<%=dataTableTitle[SESS_LANGUAGE][8]%>",
                                "sPrevious ":   "<%=dataTableTitle[SESS_LANGUAGE][9]%>"
                            }
                        },
                        "bServerSide": true,
                        "sAjaxSource": "<%= approot%>/" + servletName + "?command=<%= Command.LIST%>&FRM_FIELD_DATA_FILTER=" + datafilter + "&FRM_FIELD_DATA_FOR=" + dataFor + "&privUpdate=" + privUpdate + "&FRM_FLD_APP_ROOT=<%=approot%>"
                                + "&SEND_TGL_AWAL=" + tglAwal + "&SEND_TGL_AKHIR=" + tglAkhir + "&SEND_ID_NASABAH=" + nasabah + "&SEND_KODE_TRANSAKSI=" + transaksi + "&SEND_USER_ID=<%=userOID%>",
                        aoColumnDefs: [
                            {
                                bSortable: false,
                                aTargets: [0, -1]
                            }
                        ],
                        "initComplete": function (settings, json) {
                            if (callBackDataTables !== null) {
                                callBackDataTables();
                            }
                        },
                        "fnDrawCallback": function (oSettings) {
                            if (callBackDataTables !== null) {
                                callBackDataTables();
                            }
                            $(elementIdParent).find(".money").each(function () {
                                jMoney(this);
                                //$(this).addClass("text-right");
                            });
                        },
                        "fnPageChange": function (oSettings) {

                        }
                    });
                    $(elementIdParent).find("#" + elementId + "_filter").find("input").addClass("form-control");
                    $(elementIdParent).find("#" + elementId + "_length").find("select").addClass("form-control");
                    $("#" + elementId).css("width", "100%");
                }

                function runDataTable() {
                    dataTablesOptions("#transaksiTableElement", "tableTransaksiTableElement", "AjaxKredit", "listTransaksiKredit", null);
                }

                //MODAL SETTING
                var modalSetting = function (elementId, backdrop, keyboard, show) {
                    $(elementId).modal({
                        backdrop: backdrop,
                        keyboard: keyboard,
                        show: show
                    });
                };

                function selectMulti(id, placeholder) {
                    $(id).select2({
                        placeholder: placeholder
                    });
                }

                selectMulti('.select2nasabah', "Semua " + "<%=namaNasabah%>");
                selectMulti('.select2transaksi', "Semua Transaksi");

                $('.date-picker').datetimepicker({
                    format: "yyyy-mm-dd",
                    weekStart: 1,
                    todayBtn: 1,
                    autoclose: 1,
                    todayHighlight: 1,
                    startView: 2,
                    forceParse: 0,
                    minView: 2 // No time
                            // showMeridian: 0
                });

                runDataTable();

                $('body').on("click", ".btn_detail", function () {
                    var currentBtnHtml = $(this).html();
                    $(this).attr({"disabled": "true"});
                    var oid = $(this).data('oid');
                    var dataSend = {
                        "FRM_FIELD_OID": oid,
                        "SEND_USER_ID": "<%=userOID%>",
                        "FRM_FIELD_DATA_FOR": "getDetailTransaksi",
                        "command": "<%=Command.NONE%>"
                    };
                    onDone = function (data) {
                        var error = data.RETURN_ERROR_CODE;
                        if (error === "0") {
                            modalSetting("#modal-detailTransaksi", "static", false, false);
                            $('#modal-detailTransaksi').modal('show');
                            $('#modal-detailTransaksi').find(".money").each(function () {
                                jMoney(this);
                            });
                        } else {
                            alert(data.RETURN_MESSAGE);
                        }
                    };
                    onSuccess = function (data) {
                        $('.btn_detail').removeAttr("disabled");
                    };
                    //alert(JSON.stringify(dataSend));
                    getDataFunction(onDone, onSuccess, dataSend, "AjaxKredit", "#body_detail", false);
                });

                $('#btn_print').click(function () {
                    var buttonHtml = $(this).html();
                    $(this).attr({"disabled": "true"}).html("<i class='fa fa-spinner fa-pulse'></i> Tunggu...");
                    window.location = "list_transaksi.jsp?print_list_transaksi=1";
                    //window.print();
                    //$(this).removeAttr('disabled').html(buttonHtml);
                });

                $('body').on("click", ".btn_printTransaksi", function () {
                    var buttonHtml = $(this).html();
                    $(this).attr({"disabled": "true"}).html("Tunggu...");
                    var oid = $(this).data('oid');
                    var dataSend = {
                        "FRM_FIELD_OID": oid,
                        "FRM_FIELD_DATA_FOR": "getPrintOutNotaTransaksi",
                        "command": "<%=Command.NONE%>"
                    };
                    onDone = function (data) {
                        $('#printOut').html(data.FRM_FIELD_HTML);
                        $('#printOut').find(".money").each(function () {
                            jMoney(this);
                        });
                        $('#compName').html("<%=compName%>");
                        $('#compAddr').html("<%=compAddr%>");
                        $('#compPhone').html("<%=compPhone%>");
                        $('#adminCetak').html("<%=userFullName%>");
                        window.print();
                    };
                    onSuccess = function (data) {
                        $('.btn_printTransaksi').removeAttr('disabled').html(buttonHtml);
                    };
                    getDataFunction(onDone, onSuccess, dataSend, "AjaxKredit", "null", false);
                });

                $('#btn_cari').click(function () {
                    var awal = $('#tgl_awal').val();
                    var akhir = $('#tgl_akhir').val();
                    if (awal !== "" || akhir !== "") {
                        if (awal === "" || akhir === "") {
                            alert("Pastikan tanggal awal dan akhir diisi dengan benar");
                            return false;
                        }
                    }
                    $(this).attr({"disabled": "true"}).html("<i class='fa fa-spinner fa-pulse'></i> &nbsp; Tunggu");
                    $('#form_cari').submit();
                });
                
                $('#hapus_cari').click(function () {
                    $('#tgl_awal').val("");
                    $('#tgl_akhir').val("");
                    $('.select2nasabah').select2('');
                    $('.select2transaksi').select2('data',null);
                });
                
                $('body').on("click", ".btn_delete_trans", function () {
                    if (confirm("Yakin akan menghapus data ini ?")) {
                        hapusTransaksi(".btn_delete_trans");
                    }
                });
                
                function hapusTransaksi(btn) {
                    var buttonHtml = $(btn).html();
                    $(btn).attr({"disabled": "true"}).html("Tunggu...");
                    var oid = $(btn).data('oid');
                    var dataSend = {
                        "FRM_FIELD_OID": oid,
                        "SEND_USER_ID": "<%=userOID%>",
                        "SEND_USER_NAME": "<%=userFullName%>",
                        "FRM_FIELD_DATA_FOR": "deleteTransaction",
                        "command": "<%=Command.DELETE%>"
                    };
                    //alert(JSON.stringify(dataSend));
                    onDone = function (data) {
                        alert(data.RETURN_MESSAGE);
                        $('#modal-detailTransaksi').modal('hide');
                        runDataTable();
                    };
                    onSuccess = function (data) {
                        $(btn).removeAttr('disabled').html(buttonHtml);
                    };
                    getDataFunction(onDone, onSuccess, dataSend, "AjaxKredit", "null", false);
                }

            });
        </script>
    </head>
    <body style="background-color: #eaf3df;">
        <div class="main-page">
            <section class="content-header">
                <h1>
                    Daftar Transaksi Kredit
                    <small></small>
                </h1>
                <ol class="breadcrumb">
                    <li><a href=""><i class="fa fa-dashboard"></i> Home</a></li>
                    <li>Transaksi</li>
                    <li class="active">Kredit</li>
                </ol>
            </section>

            <section class="content">
                <div class="box box-success">

                    <div class="box-header with-border" style="border-color: lightgray">
                        <h3 class="box-title">Form Pencarian</h3>
                    </div>

                    <div class="box-body">
                        <form id="form_cari" class="form-inline" method="post" action="?command=<%=Command.LIST%>">
                            <input type="text" autocomplete="off" style="width: 150px" placeholder="Tanggal awal" id="tgl_awal" class="form-control date-picker" name="FRM_TGL_AWAL" value="<%=tglAwal%>">
                            <input type="text" autocomplete="off" style="width: 150px" placeholder="Tanggal akhir" id="tgl_akhir" class="form-control date-picker" name="FRM_TGL_AKHIR" value="<%=tglAkhir%>">

                            <select style="width: 300px" id="kode_transaksi" class="form-control input-sm select2transaksi" name="FRM_TRANSAKSI">
                                <option value="0">-- Semua Transaksi --</option>
                                <%
                                    List<Integer> useCaseType = new ArrayList<Integer>();
                                    if(useRaditya == 0){
                                    useCaseType.add(Transaksi.USECASE_TYPE_KREDIT_PENCAIRAN);
                                    }
                                    useCaseType.add(Transaksi.USECASE_TYPE_KREDIT_ANGSURAN_PAYMENT);
                                    useCaseType.add(Transaksi.USECASE_TYPE_KREDIT_BUNGA_TAMBAHAN_PENCATATAN);
                                    useCaseType.add(Transaksi.USECASE_TYPE_KREDIT_DENDA_PENCATATAN);

                                    for (int i = 0; i < useCaseType.size(); i++) {
                                        int usecase = useCaseType.get(i);
                                        String selected = "";
                                        if (arrayTransaksi != null) {
                                            for (int j = 0; j < arrayTransaksi.length; j++) {
                                                int isi = Integer.valueOf(arrayTransaksi[j]);
                                                if (isi == usecase) {
                                                    selected = "selected";
                                                    break;
                                                }
                                            }
                                        }
                                %>
                                <option <%=selected%> value="<%=useCaseType.get(i)%>"><%=Transaksi.USECASE_TYPE_TITLE.get(useCaseType.get(i))%></option>
                                <%
                                    }
                                %>
                            </select>
                            
                            <select style="width: 300px" id="id_nasabah" class="form-control input-sm select2nasabah" name="FRM_NASABAH">
                                <option value="0">-- Semua Nasabah --</option>
                                <%
                                    Vector listNasabah = SessAnggota.listJoinContactClassAssign(0, 0, ""
                                            + " cc." + PstContactClass.fieldNames[PstContactClass.FLD_CLASS_TYPE] + " = '" + PstContactClass.CONTACT_TYPE_MEMBER + "'"
                                            + " OR cc." + PstContactClass.fieldNames[PstContactClass.FLD_CLASS_TYPE] + " = '" + PstContactClass.FLD_CLASS_KELOMPOK_BADAN_USAHA + "'"
                                            + "", "cl." + PstAnggota.fieldNames[PstAnggota.FLD_NAME]);
                                    for (int i = 0; i < listNasabah.size(); i++) {
                                        Anggota a = (Anggota) listNasabah.get(i);
                                        long id = a.getOID();
                                        String selected = "";
                                        if (arrayNasabah != null) {
                                            for (int j = 0; j < arrayNasabah.length; j++) {
                                                long isi = Long.valueOf(arrayNasabah[j]);
                                                if (isi == id) {
                                                    selected = "selected";
                                                    break;
                                                }
                                            }
                                        }
                                %>
                                <option <%=selected%> value="<%=a.getOID()%>"><%=a.getName()%></option>
                                <%
                                    }
                                %>
                            </select>
                            
                            <button type="button" id="btn_cari" class="btn btn-primary"><i class="fa fa-search"></i> &nbsp; Cari</button>
                        </form>

                        <div id="transaksiTableElement">
                            <table class="table table-striped table-bordered table-responsive" style="font-size: 14px">
                                <thead>
                                    <tr>
                                        <th style="width: 1%">No.</th>
                                        <th>Tanggal Transaksi</th>
                                        <th style="width: 20%">Keterangan</th>
                                        <th>Nomor Transaksi</th>
                                        <th>Nama <%=namaNasabah%></th>
                                        <th>Lokasi</th>
                                        <th>Nomor Kredit</th>
                                        <th>Nilai Transaksi</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                                        
                        <hr style="margin: 10px 0px; border-color: lightgray">
                        <label>Keterangan :</label>
                        <table style="font-size: 14px">
                            <tr>
                                <td><%= Transaksi.KODE_TRANSAKSI_KREDIT_PENCAIRAN %></td>
                                <td>&nbsp;&nbsp; : &nbsp;&nbsp;</td>
                                <td>Transaksi pencairan kredit</td>
                            </tr>
                            <tr>
                                <td><%= Transaksi.KODE_TRANSAKSI_KREDIT_PEMBAYARAN_ANGSURAN %></td>
                                <td>&nbsp;&nbsp; : &nbsp;&nbsp;</td>
                                <td>Transaksi pembayaran angsuran kredit</td>
                            </tr>
                            <tr>
                                <td><%= Transaksi.KODE_TRANSAKSI_KREDIT_PENCATATAN_BUNGA_TAMBAHAN %></td>
                                <td>&nbsp;&nbsp; : &nbsp;&nbsp;</td>
                                <td>Transaksi pencatatan bunga kredit tambahan</td>
                            </tr>
                            <tr>
                                <td><%= Transaksi.KODE_TRANSAKSI_KREDIT_PENCATATAN_DENDA %></td>
                                <td>&nbsp;&nbsp; : &nbsp;&nbsp;</td>
                                <td>Transaksi pencatatan denda</td>
                            </tr>
                            <tr>
                                <td><%= Transaksi.KODE_TRANSAKSI_KREDIT_PENCATATAN_PENALTI_MACET %></td>
                                <td>&nbsp;&nbsp; : &nbsp;&nbsp;</td>
                                <td>Transaksi pencatatan penalty pelunasan kredit macet</td>
                            </tr>
                            <tr>
                                <td><%= Transaksi.KODE_TRANSAKSI_KREDIT_PENCATATAN_PENALTI_LUNAS_DINI %></td>
                                <td>&nbsp;&nbsp; : &nbsp;&nbsp;</td>
                                <td>Transaksi pencatatan penalty pelunasan dini</td>
                            </tr>
                        </table>
                    </div>

                    <%if (!listTransaksi.isEmpty()) {%>
                    <div class="box-footer" style="border-color: lightgray">
                        <div class="pull-right">
                            <button id="btn_print" class="btn btn-sm btn-primary"><i class="fa fa-print"></i> &nbsp; Cetak Transaksi</button>
                        </div>
                    </div>
                    <%}%>

                </div>
                    
                <a href="list_transaksi.jsp?show_history=<%= (showHistory == 0) ? "1" : "0"%>"><%= (showHistory == 0) ? "Lihat Riwayat Perubahan" : "Sembunyikan Riwayat Perubahan"%></a>
                <p></p>
                <% if (showHistory == 1) { %>
                <div class="box box-default">
                    <div class="box-header">
                        <h3 class="box-title">Riwayat Perubahan</h3>
                    </div>
                    <div class="box-body">
                        <%
                            JSONObject obj = new JSONObject();
                            JSONArray arr = new JSONArray();
                            arr.put(SessHistory.document[SessHistory.DOC_TRANSAKSI_KREDIT]);
                            obj.put("doc", arr);
                            obj.put("time", "");
                            request.setAttribute("obj", obj);
                        %>
                        <%@ include file = "/history_log/history_table.jsp" %>
                    </div>
                </div>
                <% } %>

            </section>
        </div>

        <!--------------------------------------------------------------------->

        <div id="modal-detailTransaksi" class="modal fade no-print" role="dialog">
            <div class="modal-dialog">                
                <div class="modal-content">

                    <div class="modal-header">
                        <button type="button" class="close modal-title" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Detail Transaksi</h4>
                    </div>

                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12">

                                <div id="body_detail">

                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" id="btn_close" class="btn btn-sm btn-default" data-dismiss="modal"><i class="fa fa-close"></i> &nbsp; Keluar</button>
                    </div>

                </div>
            </div>
        </div>

        <!--------------------------------------------------------------------->

    <print-area>
        <div style="size: A4" id="printOut" class="">
            <% if (print == 1) { %>
            
            <div style="width: 50%; float: left;">
                <strong style="width: 100%; display: inline-block; font-size: 20px;"><%=compName%></strong>
                <span style="width: 100%; display: inline-block;"><%=compAddr%></span>
                <span style="width: 100%; display: inline-block;"><%=compPhone%></span>                    
            </div>
            <div style="width: 50%; float: right; text-align: right">                    
                <span style="width: 100%; display: inline-block; font-weight: 400; font-size: 20px;">DAFTAR TRANSAKSI KREDIT</span>
                <span style="width: 100%; display: inline-block; font-size: 12px;">Tanggal : <%=Formater.formatDate(new Date(), "dd MMM yyyy / HH:mm:ss")%></span>                    
                <span style="width: 100%; display: inline-block; font-size: 12px;">Admin : <%=userFullName%></span>                    
            </div>
            <div class="clearfix"></div>
            <hr class="" style="border-color: gray"> 
            <table style="font-size: 12px">
                <tr>
                    <td>Tanggal</td>
                    <td style="padding: 0px 10px">&nbsp;&nbsp;:&nbsp;&nbsp;</td>
                    <td><%=textTglAwal%> s.d. <%=textTglAkhir%></td>
                </tr>
                <tr>
                    <td>Transaksi</td>
                    <td style="padding: 0px 10px">&nbsp;&nbsp;:&nbsp;&nbsp;</td>
                    <td><%=namaTransaksi%></td>
                </tr>
                <tr>
                    <td>Nasabah</td>
                    <td style="padding: 0px 10px">&nbsp;&nbsp;:&nbsp;&nbsp;</td>
                    <td><%=nasabah%></td>
                </tr>
            </table>
            <br>
            <div>
                <table class="table table-bordered tabel_data_print">
                    <thead>
                        <tr>
                            <th style="width: 1%">No.</th>
                            <th>Tanggal Transaksi</th>
                            <th style="width: 25%">Keterangan</th>
                            <th>Nomor Transaksi</th>
                            <th>Nama <%=namaNasabah%></th>
                            <th>Nilai Transaksi</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>

                        <%
                            for (int i = 0; i < listTransaksi.size(); i++) {
                                Transaksi t = (Transaksi) listTransaksi.get(i);
                                Pinjaman p = new Pinjaman();
                                Anggota a = new Anggota();
                                try {
                                    p = PstPinjaman.fetchExc(t.getPinjamanId());
                                    a = PstAnggota.fetchExc(p.getAnggotaId());
                                } catch (Exception e) {
                                    System.out.println(e);
                                }
                                //cari nilai transaksi
                                double nilaiTransaksi = 0;
                                if (t.getUsecaseType() == Transaksi.USECASE_TYPE_KREDIT_PENCAIRAN) {
                                    nilaiTransaksi = p.getJumlahPinjaman();
                                } else if (t.getUsecaseType() == Transaksi.USECASE_TYPE_KREDIT_ANGSURAN_PAYMENT) {
                                    Vector<Angsuran> listAngsuran = PstAngsuran.list(0, 0, "" + PstAngsuran.fieldNames[PstAngsuran.FLD_TRANSAKSI_ID] + " = '" + t.getOID() + "'", "");
                                    for (int j = 0; j < listAngsuran.size(); j++) {
                                        nilaiTransaksi += listAngsuran.get(j).getJumlahAngsuran();
                                    }
                                } else if (t.getUsecaseType() == Transaksi.USECASE_TYPE_KREDIT_BUNGA_TAMBAHAN_PENCATATAN) {
                                    Vector<JadwalAngsuran> listBungaTambahan = PstJadwalAngsuran.list(0, 0, PstAngsuran.fieldNames[PstAngsuran.FLD_TRANSAKSI_ID] + " = '" + t.getOID() + "'", null);
                                    for (JadwalAngsuran j : listBungaTambahan) {
                                        nilaiTransaksi += j.getJumlahANgsuran();
                                    }
                                }
                        %>

                        <tr>
                            <td><%=(i + 1)%></td>
                            <td><%=Formater.formatDate(t.getTanggalTransaksi(), "yyyy-MM-dd")%>&nbsp;&nbsp;<%=Formater.formatDate(t.getTanggalTransaksi(), "HH:mm:ss")%></td>
                            <td><%=t.getKeterangan() %></td>
                            <td><%=t.getKodeBuktiTransaksi()%></td>
                            <td><%=a.getName()%></td>
                            <td class="money text-right"><%=nilaiTransaksi%></td>
                            <td><%=Transaksi.STATUS_DOC_TRANSAKSI_TITLE[t.getStatus()]%></td>
                        </tr>

                        <%
                            }
                        %>

                    </tbody>
                </table>
            </div>
            
            <script>
                window.print();
            </script>
            <% } %>
        </div>
    </print-area>

</body>
</html>
